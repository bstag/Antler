---
import { getCollection, type CollectionEntry } from 'astro:content';
import { ArrowRight, Calendar, Clock } from 'lucide-react';
import { withBaseAsset } from '../lib/utils/base-url';

// Get featured blog posts (limit to 3)
const allPosts = await getCollection('blog');
const featuredPosts: CollectionEntry<'blog'>[] = allPosts
  .sort((a, b) => new Date(b.data.publicationDate).getTime() - new Date(a.data.publicationDate).getTime())
  .slice(0, 3);

function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(date);
}
---

<section class="py-16 bg-white dark:bg-gray-900">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Section Header -->
    <div class="text-center mb-12">
      <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">
        Latest Blog Posts
      </h2>
      <p class="text-lg text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
        Insights, tutorials, and thoughts on modern web development and static site generation.
      </p>
    </div>

    <!-- Posts Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12">
      {featuredPosts.map((post) => (
        <article class="card group hover:shadow-lg transition-all duration-300 animate-fade-in">
          <!-- Featured Image -->
          <div class="aspect-video featured-image-bg rounded-t-lg mb-4 overflow-hidden">
            <img
              src={post.data.featuredImage ? withBaseAsset(post.data.featuredImage) : `https://trae-api-us.mchost.guru/api/ide/v1/text_to_image?prompt=${encodeURIComponent(`Blog post about ${post.data.title}, modern web development, clean minimal design`)}&image_size=landscape_16_9`}
              alt={post.data.title}
              class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
              loading="lazy"
            />
          </div>

          <!-- Content -->
          <div class="p-6">
            <!-- Meta Information -->
            <div class="flex items-center text-sm text-gray-500 dark:text-gray-400 mb-3 space-x-4">
              <div class="flex items-center">
                <Calendar className="w-4 h-4 mr-1" />
                {formatDate(new Date(post.data.publicationDate))}
              </div>
              <div class="flex items-center">
                <Clock className="w-4 h-4 mr-1" />
                {post.data.readingTime} min read
              </div>
            </div>

            <!-- Title -->
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-3 group-hover:text-primary transition-colors">
              <a href={`${(import.meta.env.BASE_URL || '').replace(/\/$/, '')}/blog/${post.slug}`} class="hover:underline">
                {post.data.title}
              </a>
            </h3>

            <!-- Description -->
            <p class="text-gray-600 dark:text-gray-400 mb-4 line-clamp-3">
              {post.data.description}
            </p>

            <!-- Tags -->
            <div class="flex flex-wrap gap-2 mb-4">
              {post.data.tags.slice(0, 3).map((tag: string) => (
                <span class="badge badge-primary text-xs">
                  {tag}
                </span>
              ))}
            </div>

            <!-- Read More Link -->
            <a
              href={`/blog/${post.slug}`}
              class="inline-flex items-center text-primary hover:opacity-80 font-medium group/link"
            >
              Read More
              <ArrowRight className="ml-1 w-4 h-4 group-hover/link:translate-x-1 transition-transform" />
            </a>
          </div>
        </article>
      ))}
    </div>

    <!-- View All Posts Button -->
    <div class="text-center">
      <a
        href={`${(import.meta.env.BASE_URL || '').replace(/\/$/, '')}/blog`}
        class="btn-primary inline-flex items-center px-6 py-3"
      >
        View All Posts
        <ArrowRight className="ml-2 w-5 h-5" />
      </a>
    </div>
  </div>
</section>

<style>
  .featured-image-bg {
    background: linear-gradient(to bottom right, var(--color-primary-100), var(--color-primary-200));
  }

  :global(.dark) .featured-image-bg {
    background: linear-gradient(to bottom right, var(--color-primary-darker), var(--color-primary-darker));
    opacity: 0.2;
  }

  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
