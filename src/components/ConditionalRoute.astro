---
import { getSiteConfig } from '../lib/config/static';
import { logger } from '../lib/utils/logger';

interface Props {
  contentTypeId: string;
  fallbackComponent?: any;
}

const { contentTypeId, fallbackComponent } = Astro.props;

let isEnabled = true;
let config = null;

try {
  // Use static config loader for build-time compatibility
  config = await getSiteConfig();
  const contentType = config.contentTypes.find(ct => ct.id === contentTypeId);
  isEnabled = contentType ? contentType.enabled : false;
} catch (error) {
  logger.error('Failed to load configuration for conditional route:', error);
  // Default to enabled on error to avoid breaking existing functionality
  // This ensures that content is still accessible even if config loading fails
  isEnabled = true;
}

// If content type is disabled, render fallback or nothing.
// Status codes are handled by middleware; avoid redirect here to prevent response conflicts.
if (!isEnabled) {
  if (fallbackComponent) {
    // Render fallback component
  } else {
    // Render nothing when disabled
  }
}
---

<!-- Content type is enabled, render the slot -->
<slot />

<!-- Optional: Add debug info in development -->
{import.meta.env.DEV && (
  <div class="fixed bottom-4 right-4 bg-black/80 text-white text-xs p-2 rounded z-50">
    Content Type: {contentTypeId} - {isEnabled ? 'Enabled' : 'Disabled'}
  </div>
)}
